<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿ƒè„åº·å¤æ‰“å¡åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            padding-bottom: 60px;
        }

        /* å¯¼èˆªæ  */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: #1890ff;
            font-weight: bold;
        }

        .nav-item:active {
            background: #f0f0f0;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            display: none;
            padding: 15px;
            padding-bottom: 20px;
        }

        .page.active {
            display: block;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }

        /* é˜¶æ®µæ¦‚è§ˆ */
        .overview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .overview h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .overview-item {
            margin: 8px 0;
            font-size: 15px;
        }

        .overview-item strong {
            font-size: 18px;
        }

        /* å¤´åƒå’Œæ ‡é¢˜åŒºåŸŸ */
        .overview-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .dad-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid white;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .overview-title-section {
            flex: 1;
        }

        .overview-title-section h2 {
            margin: 0 0 5px 0;
        }

        .overview-subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-style: italic;
        }

        /* ä»»åŠ¡å¡ç‰‡ */
        .task-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .task-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .task-option:active {
            transform: scale(0.98);
        }

        .task-option.selected-yes {
            background: #52c41a;
            color: white;
            border-color: #52c41a;
        }

        .task-option.selected-no {
            background: #ff4d4f;
            color: white;
            border-color: #ff4d4f;
        }

        /* è¾“å…¥æ¡† */
        input[type="number"], input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-top: 8px;
        }

        textarea {
            min-height: 60px;
            resize: vertical;
        }

        .input-group {
            margin-top: 10px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .input-row input {
            flex: 1;
            margin-top: 0;
        }

        /* ç—‡çŠ¶å¤é€‰æ¡† */
        .checkbox-group {
            margin-top: 10px;
        }

        .checkbox-item {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        /* æŒ‰é’® */
        .btn {
            width: 100%;
            padding: 15px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .btn:active {
            background: #096dd9;
        }

        .btn-danger {
            background: #ff4d4f;
        }

        .btn-danger:active {
            background: #cf1322;
        }

        /* æç¤ºæ–‡æœ¬ */
        .hint-text {
            background: #fff7e6;
            border-left: 3px solid #faad14;
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        /* è®°å½•åˆ—è¡¨ */
        .record-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .record-date {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .record-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
        }

        .record-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .tag-success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .tag-error {
            background: #fff1f0;
            color: #ff4d4f;
            border: 1px solid #ffa39e;
        }

        .tag-info {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
            margin: 5px 0;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* è®¾ç½®é¡¹ */
        .setting-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .setting-label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        /* å¼¹å‡ºæç¤º */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            max-width: 80%;
            text-align: center;
        }

        .toast.show {
            display: block;
            animation: fadeInOut 2s;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        /* è®°å½•è¯¦æƒ…å±•å¼€ */
        .record-detail {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
            font-size: 14px;
            line-height: 1.8;
        }

        .record-detail.show {
            display: block;
        }

        .record-detail-item {
            margin: 5px 0;
        }

        /* åº·å¤é˜¶æ®µè¿›åº¦æ¡ */
        .roadmap-container {
            background: white;
            border-radius: 8px;
            padding: 20px 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .roadmap-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .roadmap-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 30px 0 20px 0;
        }

        .roadmap-line {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e0e0e0;
            z-index: 1;
        }

        .roadmap-line-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #52c41a 0%, #1890ff 100%);
            transition: width 0.5s ease;
            border-radius: 2px;
        }

        .roadmap-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .roadmap-node {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            margin-bottom: 8px;
        }

        .roadmap-stage.completed .roadmap-node {
            background: #52c41a;
            border-color: #52c41a;
            color: white;
        }

        .roadmap-stage.current .roadmap-node {
            background: #1890ff;
            border-color: #1890ff;
            color: white;
            box-shadow: 0 0 0 4px rgba(24, 144, 255, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 4px rgba(24, 144, 255, 0.2);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(24, 144, 255, 0.1);
            }
        }

        .roadmap-stage.future .roadmap-node {
            background: white;
            border-color: #e0e0e0;
            color: #999;
        }

        .roadmap-label {
            font-size: 12px;
            color: #666;
            text-align: center;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .roadmap-stage.current .roadmap-label {
            color: #1890ff;
            font-weight: bold;
        }

        .roadmap-stage.completed .roadmap-label {
            color: #52c41a;
            font-weight: bold;
        }

        .roadmap-days {
            font-size: 10px;
            color: #999;
            text-align: center;
        }

        .roadmap-overall {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .roadmap-overall-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .roadmap-percentage-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .roadmap-percentage-fill {
            height: 100%;
            background: linear-gradient(90deg, #52c41a 0%, #1890ff 50%, #722ed1 100%);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        /* è¡€å‹å¿ƒç‡æç¤º */
        .bp-hr-guide {
            background: #f0f5ff;
            border: 1px solid #d6e4ff;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }

        .bp-hr-guide-title {
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 5px;
        }

        .bp-hr-alert {
            display: none;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.6;
        }

        .bp-hr-alert.show {
            display: block;
        }

        .bp-hr-alert.normal {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }

        .bp-hr-alert.warning {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            color: #d48806;
        }

        .bp-hr-alert.danger {
            background: #fff1f0;
            border: 1px solid #ffa39e;
            color: #cf1322;
        }

        .bp-hr-alert-icon {
            font-weight: bold;
            margin-right: 5px;
        }

        .tag-warning {
            background: #fffbe6;
            color: #d48806;
            border: 1px solid #ffe58f;
        }

        .tag-danger {
            background: #fff1f0;
            color: #cf1322;
            border: 1px solid #ffa39e;
        }

        /* å¸çƒŸå–é…’é£é™©è­¦å‘Š */
        .risk-warning {
            display: none;
            margin-top: 10px;
            padding: 12px;
            border-radius: 6px;
            background: #fff1f0;
            border: 2px solid #ff4d4f;
            animation: shakeWarning 0.5s;
        }

        .risk-warning.show {
            display: block;
        }

        @keyframes shakeWarning {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .risk-warning-title {
            font-weight: bold;
            color: #cf1322;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .risk-warning-icon {
            font-size: 20px;
            margin-right: 5px;
        }

        .risk-warning-content {
            font-size: 13px;
            color: #8c0000;
            line-height: 1.6;
        }

        .risk-warning-content strong {
            color: #cf1322;
            font-size: 14px;
        }

        .risk-stats {
            margin-top: 8px;
            padding: 8px;
            background: rgba(207, 19, 34, 0.1);
            border-radius: 4px;
            font-size: 12px;
            color: #8c0000;
        }

        /* æ£€æŸ¥ç®¡ç† */
        .checkup-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #f9f9f9;
            border-left: 4px solid #ddd;
        }

        .checkup-item.done {
            background: #f6ffed;
            border-left-color: #52c41a;
        }

        .checkup-item.overdue {
            background: #fff1f0;
            border-left-color: #ff4d4f;
        }

        .checkup-item.upcoming {
            background: #fff7e6;
            border-left-color: #faad14;
        }

        .checkup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkup-title {
            font-weight: bold;
            font-size: 15px;
            color: #333;
        }

        .checkup-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .checkup-status.done {
            background: #52c41a;
            color: white;
        }

        .checkup-status.pending {
            background: #faad14;
            color: white;
        }

        .checkup-status.overdue {
            background: #ff4d4f;
            color: white;
        }

        .checkup-info {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .checkup-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .checkup-input-group input {
            flex: 1;
            margin-top: 0;
        }

        .checkup-input-group button {
            padding: 10px 20px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .checkup-input-group button:active {
            background: #096dd9;
        }

        .checkup-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
        }

        .checkup-result.good {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }

        .checkup-result.warning {
            background: #fff7e6;
            border: 1px solid #ffe58f;
            color: #d48806;
        }

        .checkup-result.danger {
            background: #fff1f0;
            border: 1px solid #ffa39e;
            color: #cf1322;
        }

        .next-checkup-small {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #1890ff;
        }

        .next-checkup-small strong {
            font-size: 15px;
            color: #0050b3;
        }

        /* å¼ºåŒ–æ¨¡å¼è­¦å‘Š */
        .intensified-warning {
            background: linear-gradient(135deg, #fff1f0 0%, #ffccc7 100%);
            border: 2px solid #ff4d4f;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(255, 77, 79, 0.2);
        }

        .intensified-warning-title {
            font-size: 16px;
            font-weight: bold;
            color: #cf1322;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .intensified-warning-content {
            font-size: 14px;
            color: #8c8c8c;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .intensified-warning-actions {
            font-size: 13px;
            color: #595959;
            line-height: 1.8;
            padding-left: 16px;
        }

        .intensified-warning-actions div {
            margin-bottom: 4px;
        }

        .intensified-warning-actions strong {
            color: #cf1322;
        }

        /* å¼ºåŒ–æ¨¡å¼ä¸‹çš„ç”¨è¯æé†’ */
        .task-meds.intensified {
            background: #fff1f0;
            border: 2px solid #ffa39e;
        }

        .task-meds.intensified .card-title {
            color: #cf1322;
            font-weight: bold;
        }

        .task-meds.intensified .card-title::before {
            content: 'âš ï¸ ';
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- æç¤ºæ¡† -->
    <div id="toast" class="toast"></div>

    <!-- ä»Šå¤©é¡µé¢ -->
    <div id="page-today" class="page active">
        <!-- é˜¶æ®µæ¦‚è§ˆ -->
        <div class="overview" id="overview">
            <div class="overview-header">
                <img class="dad-avatar" src="kaiqun-image.jpg" alt="çˆ¸çˆ¸">
                <div class="overview-title-section">
                    <h2>è€çˆ¸å¿ƒè„åº·å¤è®¡åˆ’</h2>
                </div>
            </div>
            <div class="overview-item">è·ç¦»æ‰‹æœ¯ï¼šç¬¬ <strong id="days-since-surgery">--</strong> å¤©</div>
            <div class="overview-item">å½“å‰é˜¶æ®µï¼š<strong id="current-phase">--</strong></div>
            <div class="overview-item">è¿ç»­æ— çƒŸï¼š<strong id="streak-smoke">--</strong> å¤©</div>
            <div class="overview-item">è¿ç»­æ— é…’ï¼š<strong id="streak-drink">--</strong> å¤©</div>
        </div>

        <!-- åº·å¤é˜¶æ®µè·¯çº¿å›¾ -->
        <div class="roadmap-container" id="roadmap-container">
            <div class="roadmap-title">åº·å¤é˜¶æ®µè·¯çº¿å›¾</div>
            <div class="roadmap-progress">
                <div class="roadmap-line">
                    <div class="roadmap-line-progress" id="roadmap-line-progress"></div>
                </div>

                <div class="roadmap-stage" id="stage-protection">
                    <div class="roadmap-node">ğŸ›¡ï¸</div>
                    <div class="roadmap-label">ä¿æŠ¤æœŸ</div>
                    <div class="roadmap-days">0-13å¤©</div>
                </div>

                <div class="roadmap-stage" id="stage-recovery">
                    <div class="roadmap-node">ğŸ’ª</div>
                    <div class="roadmap-label">æ¢å¤æœŸ</div>
                    <div class="roadmap-days">14-55å¤©</div>
                </div>

                <div class="roadmap-stage" id="stage-strengthening">
                    <div class="roadmap-node">â¤ï¸</div>
                    <div class="roadmap-label">å¼ºå¿ƒæœŸ</div>
                    <div class="roadmap-days">56-180å¤©</div>
                </div>

                <div class="roadmap-stage" id="stage-maintenance">
                    <div class="roadmap-node">ğŸŒŸ</div>
                    <div class="roadmap-label">ç»´æŠ¤æœŸ</div>
                    <div class="roadmap-days">180å¤©+</div>
                </div>
            </div>

            <div class="roadmap-overall">
                <div class="roadmap-overall-text">
                    <span>æ•´ä½“åº·å¤è¿›åº¦</span>
                    <span id="roadmap-percentage">0%</span>
                </div>
                <div class="roadmap-percentage-bar">
                    <div class="roadmap-percentage-fill" id="roadmap-percentage-fill"></div>
                </div>
            </div>
        </div>

        <!-- é˜¶æ®µæç¤º -->
        <div class="hint-text" id="phase-hint">
            è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­å¡«å†™æ‰‹æœ¯æ—¥æœŸã€‚
        </div>

        <!-- å¼ºåŒ–æ¨¡å¼è­¦å‘Š -->
        <div class="intensified-warning" id="intensified-warning" style="display: none;">
            <div class="intensified-warning-title">
                ğŸš¨ å¼ºåŒ–ç®¡ç†æ¨¡å¼å·²å¯åŠ¨
            </div>
            <div class="intensified-warning-content">
                æ£€æŸ¥æŒ‡æ ‡æœªè¾¾æ ‡ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨è°ƒæ•´ä¸ºå¼ºåŒ–ç®¡ç†æ¨¡å¼ï¼Œç¡®ä¿åº·å¤å®‰å…¨ã€‚
            </div>
            <div class="intensified-warning-actions">
                <div>â€¢ <strong>è¿åŠ¨ç›®æ ‡</strong>å·²é€‚å½“ä¸‹è°ƒï¼ˆ30åˆ†é’Ÿï¼‰</div>
                <div>â€¢ <strong>ç”¨è¯æé†’</strong>å·²åŠ å¼ºï¼ˆçº¢è‰²é«˜äº®ï¼‰</div>
                <div>â€¢ <strong>æ£€æŸ¥ç›‘æµ‹</strong>éœ€æ›´å¯†åˆ‡å…³æ³¨</div>
                <div>â€¢ è¯·éµåŒ»å˜±è°ƒæ•´æ²»ç–—æ–¹æ¡ˆ</div>
            </div>
        </div>

        <!-- ä¸‹ä¸€ä¸ªæ£€æŸ¥æç¤ºï¼ˆå°å¡ç‰‡ï¼‰ -->
        <div class="next-checkup-small" id="next-checkup-today" style="display: none;">
            <div id="next-checkup-today-content"></div>
        </div>

        <!-- ä»Šæ—¥è›‹ç™½è´¨æ¨è -->
        <div class="card" id="protein-recommendation-card" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); border: none;">
            <div class="card-title" style="color: white; display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ½ï¸ ä»Šæ—¥è›‹ç™½æ¨è</span>
                <button onclick="changeProteinRecommendation()" style="background: white; color: #ff6b6b; border: none; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer;">æ¢ä¸€æ¢</button>
            </div>
            <div id="protein-recommendation-content" style="background: white; border-radius: 6px; padding: 15px; margin-top: 10px;">
                <!-- æ¨èå†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
            </div>
        </div>

        <!-- æˆ’çƒŸå¡ç‰‡ -->
        <div class="card">
            <div class="card-title">ä»Šå¤©æœ‰æŠ½çƒŸå—ï¼Ÿ</div>
            <div class="task-options">
                <div class="task-option" data-task="smoke" data-value="false">æ²¡æŠ½ âœ…</div>
                <div class="task-option" data-task="smoke" data-value="true">æŠ½äº† âŒ</div>
            </div>
            <!-- å¸çƒŸé£é™©è­¦å‘Š -->
            <div class="risk-warning" id="smoke-risk-warning">
                <div class="risk-warning-title">
                    <span class="risk-warning-icon">âš ï¸</span>
                    å¿ƒæ¢—æœ¯åå¸çƒŸçš„ä¸¥é‡åæœ
                </div>
                <div class="risk-warning-content">
                    â€¢ <strong>å†æ¬¡å¿ƒæ¢—é£é™©å¢åŠ  2-3 å€</strong><br>
                    â€¢ æ”¯æ¶å†…è¡€æ “å½¢æˆé£é™©æ˜¾è‘—å‡é«˜<br>
                    â€¢ ä¸¥é‡é™ä½å¿ƒè„åº·å¤æ•ˆæœï¼Œå¯èƒ½æŠµæ¶ˆæ‰‹æœ¯æ²»ç–—<br>
                    â€¢ å¢åŠ çŒæ­»é£é™©ï¼Œå±åŠç”Ÿå‘½å®‰å…¨<br>
                    <div class="risk-stats" id="smoke-stats"></div>
                </div>
            </div>
        </div>

        <!-- æˆ’é…’å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">ä»Šå¤©æœ‰å–é…’å—ï¼Ÿ</div>
            <div class="task-options">
                <div class="task-option" data-task="drink" data-value="false">æ²¡å– âœ…</div>
                <div class="task-option" data-task="drink" data-value="true">å–äº† âŒ</div>
            </div>
            <!-- é¥®é…’é£é™©è­¦å‘Š -->
            <div class="risk-warning" id="drink-risk-warning">
                <div class="risk-warning-title">
                    <span class="risk-warning-icon">âš ï¸</span>
                    å¿ƒæ¢—æœ¯åé¥®é…’çš„ä¸¥é‡åæœ
                </div>
                <div class="risk-warning-content">
                    â€¢ <strong>å†æ¬¡å¿ƒæ¢—å’ŒçŒæ­»é£é™©å¢åŠ </strong><br>
                    â€¢ å¯èƒ½ä¸å¿ƒè„è¯ç‰©äº§ç”Ÿå±é™©çš„ç›¸äº’ä½œç”¨<br>
                    â€¢ å‡é«˜è¡€å‹ï¼Œå¢åŠ å¿ƒè„è´Ÿæ‹…<br>
                    â€¢ å½±å“å¿ƒè‚Œæ¢å¤ï¼Œé™ä½åº·å¤æ•ˆæœ<br>
                    <div class="risk-stats" id="drink-stats"></div>
                </div>
            </div>
        </div>

        <!-- åƒè¯å¡ç‰‡ -->
        <div class="card" id="meds-card">
            <div class="card-title">ä»Šå¤©æŒ‰æ—¶åƒè¯äº†å—ï¼Ÿ</div>
            <div class="task-options">
                <div class="task-option" data-task="meds" data-value="true">å·²æŒ‰æ—¶åƒå®Œ âœ…</div>
                <div class="task-option" data-task="meds" data-value="false">æ²¡å®Œå…¨æŒ‰æ—¶ âŒ</div>
            </div>
        </div>

        <!-- è¿åŠ¨å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">ä»Šå¤©è¿åŠ¨ / èµ°è·¯</div>
            <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                ä»Šæ—¥å»ºè®®ï¼š<strong id="exercise-target">--</strong> åˆ†é’Ÿ
            </div>
            <div class="input-group">
                <label class="input-label">å®é™…å®Œæˆï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" id="exercise-minutes" placeholder="è¾“å…¥è¿åŠ¨åˆ†é’Ÿæ•°" min="0">
            </div>
        </div>

        <!-- è¡€å‹/å¿ƒç‡å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">ä»Šå¤©è¡€å‹ / å¿ƒç‡</div>
            <div class="input-row">
                <input type="number" id="bp-sys" placeholder="æ”¶ç¼©å‹" min="0" onchange="checkVitalSigns()">
                <input type="number" id="bp-dia" placeholder="èˆ’å¼ å‹" min="0" onchange="checkVitalSigns()">
                <input type="number" id="heart-rate" placeholder="å¿ƒç‡" min="0" onchange="checkVitalSigns()">
            </div>

            <!-- æ­£å¸¸èŒƒå›´æŒ‡å— -->
            <div class="bp-hr-guide">
                <div class="bp-hr-guide-title">ğŸ“Š å‚è€ƒèŒƒå›´</div>
                <div>â€¢ æ”¶ç¼©å‹ï¼š90-140 mmHg</div>
                <div>â€¢ èˆ’å¼ å‹ï¼š60-90 mmHg</div>
                <div>â€¢ å¿ƒç‡ï¼š60-100 æ¬¡/åˆ†</div>
            </div>

            <!-- å®æ—¶æ£€æµ‹æç¤º -->
            <div class="bp-hr-alert" id="bp-hr-alert"></div>
        </div>

        <!-- ç—‡çŠ¶/å¤‡æ³¨å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">ç—‡çŠ¶ / å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</div>
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" name="symptom" value="èƒ¸ç—›"> èƒ¸ç—›
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" name="symptom" value="èƒ¸é—·"> èƒ¸é—·
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" name="symptom" value="å¿ƒæ‚¸"> å¿ƒæ‚¸
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" name="symptom" value="æ°”çŸ­"> æ°”çŸ­
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" name="symptom" value="ä¸‹è‚¢æ°´è‚¿"> ä¸‹è‚¢æ°´è‚¿
                </label>
            </div>
            <textarea id="note" placeholder="å…¶ä»–å¤‡æ³¨..."></textarea>
        </div>

        <!-- ä¿å­˜æŒ‰é’® -->
        <button class="btn" onclick="saveTodayRecord()">ä¿å­˜ä»Šå¤©çš„è®°å½•</button>
    </div>

    <!-- è®°å½•é¡µé¢ -->
    <div id="page-records" class="page">
        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">è¿ç»­æ— çƒŸ</div>
                <div class="stat-value" id="stat-smoke-current">0</div>
                <div class="stat-label">å¤©ï¼ˆæœ€é•¿: <span id="stat-smoke-max">0</span>å¤©ï¼‰</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">è¿ç»­æ— é…’</div>
                <div class="stat-value" id="stat-drink-current">0</div>
                <div class="stat-label">å¤©ï¼ˆæœ€é•¿: <span id="stat-drink-max">0</span>å¤©ï¼‰</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">7å¤©å¹³å‡è¿åŠ¨</div>
            <div style="font-size: 24px; font-weight: bold; color: #1890ff; text-align: center; padding: 10px 0;">
                <span id="stat-avg-exercise">0</span> åˆ†é’Ÿ/å¤©
            </div>
        </div>

        <!-- å¸çƒŸå–é…’ç»Ÿè®¡è­¦å‘Š -->
        <div class="card" id="risky-behavior-stats" style="display: none;">
            <div class="card-title" style="color: #cf1322;">âš ï¸ å±é™©è¡Œä¸ºè®°å½•</div>
            <div style="padding: 10px; background: #fff1f0; border-radius: 6px; border: 1px solid #ffa39e;">
                <div style="margin-bottom: 10px;">
                    <strong style="color: #cf1322;">æœ¯åå¸çƒŸæ¬¡æ•°ï¼š</strong>
                    <span id="stat-smoke-total" style="font-size: 20px; font-weight: bold; color: #cf1322;">0</span> æ¬¡
                    <span id="stat-smoke-recent" style="font-size: 14px; color: #8c0000; margin-left: 10px;"></span>
                </div>
                <div>
                    <strong style="color: #cf1322;">æœ¯åé¥®é…’æ¬¡æ•°ï¼š</strong>
                    <span id="stat-drink-total" style="font-size: 20px; font-weight: bold; color: #cf1322;">0</span> æ¬¡
                    <span id="stat-drink-recent" style="font-size: 14px; color: #8c0000; margin-left: 10px;"></span>
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ffa39e; font-size: 13px; color: #8c0000;">
                    æ¯æ¬¡å¸çƒŸæˆ–é¥®é…’éƒ½åœ¨å¢åŠ å†æ¬¡å¿ƒæ¢—å’ŒçŒæ­»çš„é£é™©ï¼ä¸ºäº†ç”Ÿå‘½å®‰å…¨ï¼Œè¯·ç«‹å³å½»åº•æˆ’é™¤ï¼
                </div>
            </div>
        </div>

        <!-- è®°å½•åˆ—è¡¨ -->
        <div id="records-list">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <div>è¿˜æ²¡æœ‰è®°å½•</div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¡µé¢ -->
    <div id="page-settings" class="page">
        <div class="setting-item">
            <div class="setting-label">æ‰‹æœ¯æ—¥æœŸï¼ˆå¿…å¡«ï¼‰</div>
            <input type="date" id="surgery-date">
        </div>

        <div class="setting-item">
            <div class="setting-label">è¿åŠ¨ç›®æ ‡è®¾ç½®</div>
            <div class="task-options" style="margin-top: 10px;">
                <div class="task-option" data-task="exercise-mode" data-value="auto">æŒ‰ç³»ç»Ÿæ¨è</div>
                <div class="task-option" data-task="exercise-mode" data-value="custom">è‡ªå®šä¹‰ç›®æ ‡</div>
            </div>
            <div id="custom-exercise-input" style="display: none; margin-top: 10px;">
                <label class="input-label">æ¯æ—¥ç›®æ ‡ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" id="custom-exercise-target" placeholder="è¾“å…¥åˆ†é’Ÿæ•°" min="0">
            </div>
        </div>

        <button class="btn" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>

        <div class="setting-item" style="margin-top: 20px;">
            <div class="setting-label">æ•°æ®ç®¡ç†</div>
            <button class="btn" onclick="exportData()">å¯¼å‡ºæ•°æ®ï¼ˆJSONï¼‰</button>
            <button class="btn btn-danger" onclick="clearAllData()" style="margin-top: 10px;">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
        </div>
    </div>

    <!-- æ£€æŸ¥é¡µé¢ -->
    <div id="page-checkups" class="page">
        <!-- ä¸‹ä¸€ä¸ªæ£€æŸ¥æé†’ -->
        <div class="card" id="next-checkup-card" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-title" style="color: white;">ğŸ©º ä¸‹ä¸€ä¸ªæ£€æŸ¥</div>
            <div id="next-checkup-info" style="font-size: 16px; margin-top: 10px;"></div>
        </div>

        <!-- æ£€æŸ¥æ¸…å• -->
        <div class="card">
            <div class="card-title">æ£€æŸ¥è®¡åˆ’æ¸…å•</div>
            <div id="checkup-list"></div>
        </div>

        <!-- æ£€æŸ¥è¯´æ˜ -->
        <div class="card">
            <div class="card-title">ğŸ“– æ£€æŸ¥é¡¹ç›®è¯´æ˜</div>
            <div style="line-height: 1.8; font-size: 14px;">
                <div style="margin-bottom: 15px;">
                    <strong style="color: #1890ff;">âœ” è¡€è„‚ï¼ˆLDLï¼‰æ£€æŸ¥</strong><br>
                    â€¢ æœ€é‡è¦çš„æ£€æŸ¥ï¼Œå†³å®šæ˜¯å¦å†å µã€æ˜¯å¦äºŒæ¬¡å¿ƒæ¢—<br>
                    â€¢ å¿…é¡»å‹åˆ° <strong style="color: #cf1322;">1.4 mmol/L ä»¥ä¸‹</strong><br>
                    â€¢ æœ¯åéœ€è¦å¤šæ¬¡å¤æŸ¥ç¡®ä¿è¾¾æ ‡
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #1890ff;">âœ” å¿ƒè„å½©è¶…ï¼ˆEF å°„è¡€åˆ†æ•°ï¼‰</strong><br>
                    â€¢ EF = å¿ƒè„æ³µè¡€èƒ½åŠ›<br>
                    â€¢ <strong style="color: #52c41a;">EF > 50%</strong>ï¼šæ­£å¸¸<br>
                    â€¢ <strong style="color: #faad14;">EF 40-50%</strong>ï¼šéœ€è¦æ³¨æ„<br>
                    â€¢ <strong style="color: #cf1322;">EF < 40%</strong>ï¼šé«˜é£é™©ï¼Œéœ€ä¸¥æ ¼ç®¡ç†
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #1890ff;">âœ” å¿ƒç”µå›¾ï¼ˆECGï¼‰</strong><br>
                    â€¢ æ£€æŸ¥å¿ƒå¾‹é—®é¢˜<br>
                    â€¢ æœ‰äº›å¿ƒå¾‹å¤±å¸¸ä¼šå¯¼è‡´çŒæ­»é£é™©å¢åŠ 
                </div>
                <div>
                    <strong style="color: #1890ff;">âœ” è‚åŠŸèƒ½</strong><br>
                    â€¢ å› ä¸ºæœç”¨ä»–æ±€ç±»è¯ç‰©å¿…é¡»ç›‘æµ‹è‚è„åŠŸèƒ½
                </div>
            </div>
        </div>

        <!-- æœªè¾¾æ ‡è¯´æ˜ -->
        <div class="card" style="background: linear-gradient(135deg, #fff1f0 0%, #ffe7e3 100%); border: 2px solid #ffa39e;">
            <div class="card-title" style="color: #cf1322;">âš ï¸ æŒ‡æ ‡æœªè¾¾æ ‡åæœè¯´æ˜</div>
            <div style="line-height: 1.8; font-size: 14px; color: #595959;">
                <div style="margin-bottom: 15px;">
                    <strong style="color: #cf1322;">ç³»ç»Ÿä¼šè‡ªåŠ¨å¯åŠ¨å¼ºåŒ–ç®¡ç†æ¨¡å¼</strong>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>è§¦å‘æ¡ä»¶ï¼š</strong><br>
                    â€¢ æ¢å¤æœŸæ£€æŸ¥ LDL â‰¥ 1.8 mmol/Lï¼ˆä¸¥é‡æœªè¾¾æ ‡ï¼‰<br>
                    â€¢ æˆ– EF < 40%ï¼ˆå¿ƒåŠŸèƒ½ä¸å…¨ï¼‰
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>å¼ºåŒ–æ¨¡å¼è°ƒæ•´ï¼š</strong><br>
                    â€¢ ğŸƒ è¿åŠ¨ç›®æ ‡ä¸‹è°ƒè‡³ 30 åˆ†é’Ÿï¼ˆæ›´ä¿å®ˆï¼‰<br>
                    â€¢ ğŸ’Š ç”¨è¯æé†’åŠ å¼ºï¼ˆçº¢è‰²é«˜äº®ï¼‰<br>
                    â€¢ ğŸ“Š éœ€è¦æ›´å¯†åˆ‡ç›‘æµ‹å„é¡¹æŒ‡æ ‡<br>
                    â€¢ ğŸ©º å¯èƒ½éœ€è¦å¢åŠ å¤æŸ¥é¢‘ç‡
                </div>
                <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #ffa39e;">
                    <strong style="color: #cf1322;">âš ï¸ é‡è¦æç¤ºï¼š</strong><br>
                    å¦‚æœè¿›å…¥å¼ºåŒ–æ¨¡å¼ï¼Œè¯·åŠ¡å¿…ï¼š<br>
                    1. å°½å¿«å’¨è¯¢ä¸»æ²»åŒ»ç”Ÿï¼Œè°ƒæ•´æ²»ç–—æ–¹æ¡ˆ<br>
                    2. ä¸¥æ ¼æŒ‰åŒ»å˜±æœè¯ï¼Œä¸å¯è‡ªè¡Œå‡é‡æˆ–åœè¯<br>
                    3. å¯†åˆ‡å…³æ³¨ç—‡çŠ¶å˜åŒ–<br>
                    4. è€ƒè™‘å¢åŠ å¤æŸ¥é¢‘ç‡
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('today')">ä»Šå¤©</div>
        <div class="nav-item" onclick="switchPage('records')">è®°å½•</div>
        <div class="nav-item" onclick="switchPage('checkups')">æ£€æŸ¥</div>
        <div class="nav-item" onclick="switchPage('settings')">è®¾ç½®</div>
    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        const STORAGE_KEYS = {
            RECORDS: 'heartRehabRecords',
            SETTINGS: 'heartRehabSettings',
            CHECKUPS: 'heartRehabCheckups'
        };

        // å…¨å±€é…ç½®æ•°æ®ï¼ˆä»data.jsonåŠ è½½ï¼‰
        let CONFIG_DATA = null;

        let currentPage = 'today';
        let todayData = {};
        let currentProteinRecommendation = null;

        // ==================== åŠ è½½é…ç½®æ•°æ® ====================
        async function loadConfigData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error('Failed to load config data');
                }
                CONFIG_DATA = await response.json();
                console.log('é…ç½®æ•°æ®åŠ è½½æˆåŠŸ');
                return CONFIG_DATA;
            } catch (error) {
                console.error('åŠ è½½é…ç½®æ•°æ®å¤±è´¥:', error);
                showToast('é…ç½®æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return null;
            }
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function switchPage(page) {
            currentPage = page;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(`page-${page}`).classList.add('active');
            event.target.classList.add('active');

            if (page === 'today') {
                loadTodayPage();
            } else if (page === 'records') {
                loadRecordsPage();
            } else if (page === 'checkups') {
                loadCheckupsPage();
            } else if (page === 'settings') {
                loadSettingsPage();
            }
        }

        // ==================== é˜¶æ®µè®¡ç®— ====================
        function calculatePhase(surgeryDate) {
            if (!surgeryDate) return null;

            const surgery = new Date(surgeryDate);
            const today = new Date();
            const days = Math.floor((today - surgery) / (1000 * 60 * 60 * 24));

            let phase, phaseName, hint, target, intensified = false;

            if (days < 0) {
                return { days: 0, phase: 'pre', phaseName: 'æœªå¼€å§‹', hint: 'æ‰‹æœ¯æ—¥æœŸè®¾ç½®æœ‰è¯¯', target: 0, intensified: false };
            } else if (days <= 13) {
                phase = 'protection';
                phaseName = 'ä¿æŠ¤æœŸ';
                hint = 'ç°åœ¨æ˜¯æœ¯åä¿æŠ¤æœŸï¼Œé‡ç‚¹æ˜¯è½»å¾®æ´»åŠ¨ + ä¼‘æ¯ï¼Œä¸è¦ç”¨åŠ›ï¼Œä¸è¦å¿«èµ°ã€‚å¦‚æœå‡ºç°èƒ¸ç—›ã€æ˜æ˜¾æ°”å–˜ã€å‡ºå†·æ±—ï¼Œè¯·ç«‹åˆ»åœæ­¢å¹¶å°±åŒ»ã€‚';
                target = 15;
            } else if (days <= 55) {
                phase = 'recovery';
                phaseName = 'æ¢å¤æœŸ';
                hint = 'ç°åœ¨æ˜¯æ¢å¤æœŸï¼Œç›®æ ‡æ˜¯æ¯å¤©åšæŒèµ°è·¯ï¼Œé€æ­¥å¢åŠ æ—¶é—´ï¼Œä½†ä¸è¦å‹‰å¼ºã€‚';

                if (days <= 20) target = 20;
                else if (days <= 27) target = 25;
                else if (days <= 41) target = 30;
                else target = 35;
            } else if (days <= 180) {
                phase = 'strengthening';
                phaseName = 'å¼ºå¿ƒæœŸ';

                // æ£€æŸ¥æ¢å¤æœŸçš„æ£€æŸ¥æŒ‡æ ‡æ˜¯å¦è¾¾æ ‡
                const checkups = getCheckups();
                const needsIntensified = checkIfNeedsIntensification(checkups);

                if (needsIntensified) {
                    intensified = true;
                    phaseName = 'å¼ºå¿ƒæœŸï¼ˆå¼ºåŒ–ç‰ˆï¼‰';
                    hint = 'âš ï¸ æ£€æŸ¥æŒ‡æ ‡æœªè¾¾æ ‡ï¼Œå¯åŠ¨å¼ºåŒ–ç®¡ç†æ¨¡å¼ï¼šè¿åŠ¨é€‚å½“ä¸‹è°ƒã€åŠ å¼ºç”¨è¯ã€å¯†åˆ‡ç›‘æµ‹ã€‚è¯·éµåŒ»å˜±è°ƒæ•´æ²»ç–—æ–¹æ¡ˆã€‚';
                    target = 30; // å¼ºåŒ–æ¨¡å¼ä¸‹è¿åŠ¨ç›®æ ‡ä¸‹è°ƒ
                } else {
                    hint = 'ç°åœ¨æ˜¯å¼ºå¿ƒæœŸï¼ŒæŒç»­çš„è¿åŠ¨å¯ä»¥è®©å¿ƒè„è¶Šæ¥è¶Šç¨³å®šã€‚';
                    target = 40;
                }
            } else {
                phase = 'maintenance';
                phaseName = 'é•¿æœŸç»´æŠ¤æœŸ';
                hint = 'ç»§ç»­ä¿æŒè‰¯å¥½çš„ä¹ æƒ¯ï¼Œè¿™æ˜¯é•¿æœŸå¥åº·çš„å…³é”®ã€‚';
                target = 40;
            }

            return { days, phase, phaseName, hint, target, intensified };
        }

        // ==================== æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåŒ–æ¨¡å¼ ====================
        function checkIfNeedsIntensification(checkups) {
            if (!checkups) return false;

            let hasFailedCheck = false;

            // æ£€æŸ¥è¡€è„‚æ£€æŸ¥1ï¼ˆåº”åœ¨æ¢å¤æœŸå®Œæˆï¼‰
            if (checkups.firstLipid && checkups.firstLipid.done) {
                const ldl = checkups.firstLipid.LDL;
                if (ldl && ldl >= 1.8) {
                    hasFailedCheck = true;
                }
            }

            // æ£€æŸ¥å¿ƒç”µå›¾+å½©è¶…ï¼ˆåº”åœ¨æ¢å¤æœŸæˆ–å¼ºå¿ƒæœŸåˆæœŸå®Œæˆï¼‰
            if (checkups.echoECG && checkups.echoECG.done) {
                const ef = checkups.echoECG.EF;
                if (ef && ef < 40) {
                    hasFailedCheck = true;
                }
            }

            return hasFailedCheck;
        }

        // ==================== è®¡ç®—è¿ç»­å¤©æ•° ====================
        function calculateStreak(records, checkField) {
            if (!records || records.length === 0) return { current: 0, max: 0 };

            const sortedRecords = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));

            let currentStreak = 0;
            let maxStreak = 0;
            let tempStreak = 0;

            const today = new Date().toISOString().split('T')[0];
            let checkDate = new Date(today);

            for (const record of sortedRecords) {
                const recordDate = record.date;
                const expectedDate = checkDate.toISOString().split('T')[0];

                if (recordDate === expectedDate) {
                    if (record[checkField] === false) {
                        tempStreak++;
                        if (recordDate === today || (new Date(today) - new Date(recordDate)) / (1000 * 60 * 60 * 24) < 1) {
                            currentStreak = tempStreak;
                        }
                    } else {
                        if (currentStreak === 0) currentStreak = 0;
                        tempStreak = 0;
                    }
                    maxStreak = Math.max(maxStreak, tempStreak);
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return { current: currentStreak, max: maxStreak };
        }

        // ==================== è›‹ç™½è´¨æ¨èåŠŸèƒ½ ====================
        function getRandomProteinRecommendation(phase) {
            if (!CONFIG_DATA || !phase || !CONFIG_DATA.proteinRecommendations[phase]) {
                return null;
            }

            const recommendations = CONFIG_DATA.proteinRecommendations[phase];
            const randomIndex = Math.floor(Math.random() * recommendations.length);
            return recommendations[randomIndex];
        }

        function displayProteinRecommendation(phaseInfo) {
            if (!phaseInfo) return;

            const recommendation = getRandomProteinRecommendation(phaseInfo.phase);
            if (!recommendation) return;

            currentProteinRecommendation = recommendation;

            const contentDiv = document.getElementById('protein-recommendation-content');
            if (!contentDiv) return;

            let html = `
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 18px; font-weight: bold; color: #ff6b6b; margin-bottom: 8px;">
                        ${recommendation.name}
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px;">
                        <div style="background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 4px; font-size: 13px;">
                            ğŸ“ ${recommendation.amount}
                        </div>
                        <div style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 4px; font-size: 13px;">
                            ğŸ´ ${recommendation.meal}
                        </div>
                    </div>
            `;

            if (recommendation.note) {
                html += `
                    <div style="font-size: 13px; color: #666; line-height: 1.6; padding: 8px; background: #f5f5f5; border-radius: 4px; border-left: 3px solid #ff6b6b;">
                        ğŸ’¡ ${recommendation.note}
                    </div>
                `;
            }

            html += '</div>';

            contentDiv.innerHTML = html;
        }

        function changeProteinRecommendation() {
            const settings = getSettings();
            const phaseInfo = calculatePhase(settings.surgeryDate);

            if (!phaseInfo) {
                showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™æ‰‹æœ¯æ—¥æœŸ');
                return;
            }

            displayProteinRecommendation(phaseInfo);
            showToast('å·²ä¸ºæ‚¨æ¢ä¸€é“æ¨è ğŸ˜Š');
        }

        // ==================== åŠ è½½ä»Šå¤©é¡µé¢ ====================
        function loadTodayPage() {
            const settings = getSettings();
            const phaseInfo = calculatePhase(settings.surgeryDate);

            if (!phaseInfo) {
                document.getElementById('days-since-surgery').textContent = '--';
                document.getElementById('current-phase').textContent = '--';
                document.getElementById('streak-smoke').textContent = '--';
                document.getElementById('streak-drink').textContent = '--';
                document.getElementById('phase-hint').textContent = 'è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­å¡«å†™æ‰‹æœ¯æ—¥æœŸã€‚';
                document.getElementById('exercise-target').textContent = '--';
                // éšè—è·¯çº¿å›¾
                document.getElementById('roadmap-container').style.display = 'none';
                return;
            }

            // æ˜¾ç¤ºè·¯çº¿å›¾
            document.getElementById('roadmap-container').style.display = 'block';

            const records = getRecords();
            const smokeStreak = calculateStreak(records, 'smoked');
            const drinkStreak = calculateStreak(records, 'drank');

            document.getElementById('days-since-surgery').textContent = phaseInfo.days;
            document.getElementById('current-phase').textContent = phaseInfo.phaseName;
            document.getElementById('streak-smoke').textContent = smokeStreak.current;
            document.getElementById('streak-drink').textContent = drinkStreak.current;
            document.getElementById('phase-hint').textContent = phaseInfo.hint;

            const exerciseTarget = settings.exerciseMode === 'custom' ?
                (settings.customExerciseTarget || phaseInfo.target) : phaseInfo.target;
            document.getElementById('exercise-target').textContent = exerciseTarget;

            // æ›´æ–°åº·å¤é˜¶æ®µè·¯çº¿å›¾
            updateRoadmap(phaseInfo);

            // åŠ è½½ä»Šå¤©çš„å·²ä¿å­˜æ•°æ®
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = records.find(r => r.date === today);

            if (todayRecord) {
                loadTodayRecord(todayRecord);
            } else {
                clearTodayForm();
            }

            // æ˜¾ç¤º/éšè—å¼ºåŒ–æ¨¡å¼è­¦å‘Š
            const intensifiedWarning = document.getElementById('intensified-warning');
            const medsCard = document.getElementById('meds-card');

            if (phaseInfo.intensified) {
                intensifiedWarning.style.display = 'block';
                medsCard.classList.add('intensified');
            } else {
                intensifiedWarning.style.display = 'none';
                medsCard.classList.remove('intensified');
            }

            // æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ£€æŸ¥æç¤º
            showNextCheckupInToday();

            // æ˜¾ç¤ºè›‹ç™½è´¨æ¨è
            displayProteinRecommendation(phaseInfo);
        }

        // ==================== æ›´æ–°åº·å¤é˜¶æ®µè·¯çº¿å›¾ ====================
        function updateRoadmap(phaseInfo) {
            const { days, phase } = phaseInfo;

            // é‡ç½®æ‰€æœ‰é˜¶æ®µçŠ¶æ€
            const stages = ['protection', 'recovery', 'strengthening', 'maintenance'];
            stages.forEach(stageName => {
                const stageElement = document.getElementById(`stage-${stageName}`);
                stageElement.classList.remove('completed', 'current', 'future');
            });

            // é˜¶æ®µæ˜ å°„åˆ°ç´¢å¼•
            const phaseMap = {
                'protection': 0,
                'recovery': 1,
                'strengthening': 2,
                'maintenance': 3
            };

            const currentPhaseIndex = phaseMap[phase] || 0;

            // è®¾ç½®æ¯ä¸ªé˜¶æ®µçš„çŠ¶æ€
            stages.forEach((stageName, index) => {
                const stageElement = document.getElementById(`stage-${stageName}`);
                if (index < currentPhaseIndex) {
                    stageElement.classList.add('completed');
                } else if (index === currentPhaseIndex) {
                    stageElement.classList.add('current');
                } else {
                    stageElement.classList.add('future');
                }
            });

            // è®¡ç®—è¿æ¥çº¿çš„è¿›åº¦
            let lineProgressPercentage = 0;

            if (days <= 13) {
                // ä¿æŠ¤æœŸ (0-13å¤©)
                lineProgressPercentage = (days / 13) * (100 / 3) * 0.33;
            } else if (days <= 55) {
                // æ¢å¤æœŸ (14-55å¤©)
                const recoveryProgress = (days - 14) / (55 - 14);
                lineProgressPercentage = 33.33 + (recoveryProgress * 33.33);
            } else if (days <= 180) {
                // å¼ºå¿ƒæœŸ (56-180å¤©)
                const strengtheningProgress = (days - 56) / (180 - 56);
                lineProgressPercentage = 66.66 + (strengtheningProgress * 33.33);
            } else {
                // ç»´æŠ¤æœŸ (180å¤©+)
                lineProgressPercentage = 100;
            }

            document.getElementById('roadmap-line-progress').style.width = lineProgressPercentage + '%';

            // è®¡ç®—æ•´ä½“åº·å¤è¿›åº¦ï¼ˆä»¥180å¤©ä¸ºå®Œæ•´å‘¨æœŸï¼‰
            const overallPercentage = Math.min(Math.round((days / 180) * 100), 100);
            document.getElementById('roadmap-percentage').textContent = overallPercentage + '%';
            document.getElementById('roadmap-percentage-fill').style.width = overallPercentage + '%';
        }

        // ==================== åŠ è½½ä»Šå¤©å·²ä¿å­˜çš„è®°å½• ====================
        function loadTodayRecord(record) {
            // æˆ’çƒŸ
            selectOption('smoke', String(record.smoked));
            // æˆ’é…’
            selectOption('drink', String(record.drank));
            // åƒè¯
            selectOption('meds', String(record.medsTaken));
            // è¿åŠ¨
            document.getElementById('exercise-minutes').value = record.exerciseMinutes || '';
            // è¡€å‹å¿ƒç‡
            document.getElementById('bp-sys').value = record.bpSys || '';
            document.getElementById('bp-dia').value = record.bpDia || '';
            document.getElementById('heart-rate').value = record.heartRate || '';
            // ç—‡çŠ¶
            document.querySelectorAll('input[name="symptom"]').forEach(cb => {
                cb.checked = record.symptoms && record.symptoms.includes(cb.value);
            });
            // å¤‡æ³¨
            document.getElementById('note').value = record.note || '';

            // è§¦å‘è¡€å‹å¿ƒç‡æ£€æŸ¥
            checkVitalSigns();
        }

        // ==================== æ¸…ç©ºä»Šå¤©è¡¨å• ====================
        function clearTodayForm() {
            document.querySelectorAll('.task-option').forEach(opt => {
                opt.classList.remove('selected-yes', 'selected-no');
            });
            document.getElementById('exercise-minutes').value = '';
            document.getElementById('bp-sys').value = '';
            document.getElementById('bp-dia').value = '';
            document.getElementById('heart-rate').value = '';
            document.querySelectorAll('input[name="symptom"]').forEach(cb => cb.checked = false);
            document.getElementById('note').value = '';
            todayData = {};

            // æ¸…é™¤è¡€å‹å¿ƒç‡æç¤º
            const alertBox = document.getElementById('bp-hr-alert');
            if (alertBox) {
                alertBox.classList.remove('show', 'normal', 'warning', 'danger');
            }
        }

        // ==================== é€‰é¡¹é€‰æ‹©è¾…åŠ©å‡½æ•° ====================
        function selectOption(task, value) {
            const options = document.querySelectorAll(`[data-task="${task}"]`);
            options.forEach(opt => {
                opt.classList.remove('selected-yes', 'selected-no');
                if (opt.dataset.value === value) {
                    if (task === 'smoke' || task === 'drink') {
                        opt.classList.add(value === 'false' ? 'selected-yes' : 'selected-no');
                    } else if (task === 'meds') {
                        opt.classList.add(value === 'true' ? 'selected-yes' : 'selected-no');
                    } else {
                        opt.classList.add('selected-yes');
                    }
                }
            });
        }

        // ==================== æ£€æŸ¥è¡€å‹å¿ƒç‡æ˜¯å¦æ­£å¸¸ ====================
        function checkVitalSigns() {
            const bpSys = parseInt(document.getElementById('bp-sys').value);
            const bpDia = parseInt(document.getElementById('bp-dia').value);
            const heartRate = parseInt(document.getElementById('heart-rate').value);

            const alertBox = document.getElementById('bp-hr-alert');

            // å¦‚æœæ²¡æœ‰è¾“å…¥ä»»ä½•å€¼ï¼Œéšè—æç¤º
            if (!bpSys && !bpDia && !heartRate) {
                alertBox.classList.remove('show');
                return null;
            }

            let issues = [];
            let level = 'normal'; // normal, warning, danger

            // æ£€æŸ¥æ”¶ç¼©å‹
            if (bpSys) {
                if (bpSys < 90) {
                    issues.push('æ”¶ç¼©å‹åä½');
                    level = 'warning';
                } else if (bpSys > 180) {
                    issues.push('æ”¶ç¼©å‹è¿‡é«˜');
                    level = 'danger';
                } else if (bpSys > 140) {
                    issues.push('æ”¶ç¼©å‹åé«˜');
                    if (level !== 'danger') level = 'warning';
                }
            }

            // æ£€æŸ¥èˆ’å¼ å‹
            if (bpDia) {
                if (bpDia < 60) {
                    issues.push('èˆ’å¼ å‹åä½');
                    if (level !== 'danger') level = 'warning';
                } else if (bpDia > 110) {
                    issues.push('èˆ’å¼ å‹è¿‡é«˜');
                    level = 'danger';
                } else if (bpDia > 90) {
                    issues.push('èˆ’å¼ å‹åé«˜');
                    if (level !== 'danger') level = 'warning';
                }
            }

            // æ£€æŸ¥å¿ƒç‡
            if (heartRate) {
                if (heartRate < 50) {
                    issues.push('å¿ƒç‡è¿‡æ…¢');
                    level = 'danger';
                } else if (heartRate < 60) {
                    issues.push('å¿ƒç‡åæ…¢');
                    if (level !== 'danger') level = 'warning';
                } else if (heartRate > 120) {
                    issues.push('å¿ƒç‡è¿‡å¿«');
                    level = 'danger';
                } else if (heartRate > 100) {
                    issues.push('å¿ƒç‡åå¿«');
                    if (level !== 'danger') level = 'warning';
                }
            }

            // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
            alertBox.classList.remove('normal', 'warning', 'danger');

            if (issues.length === 0) {
                alertBox.classList.add('show', 'normal');
                alertBox.innerHTML = '<span class="bp-hr-alert-icon">âœ…</span> æ•°å€¼åœ¨æ­£å¸¸èŒƒå›´å†…';
            } else if (level === 'warning') {
                alertBox.classList.add('show', 'warning');
                let advice = 'å»ºè®®ï¼šç»§ç»­è§‚å¯Ÿï¼Œå¦‚æŒç»­å¼‚å¸¸æˆ–ä¼´æœ‰ä¸é€‚ç—‡çŠ¶ï¼Œè¯·å’¨è¯¢åŒ»ç”Ÿã€‚';
                alertBox.innerHTML = `<span class="bp-hr-alert-icon">âš ï¸</span> ${issues.join('ã€')}<br>${advice}`;
            } else if (level === 'danger') {
                alertBox.classList.add('show', 'danger');
                let advice = 'âš ï¸ é‡è¦æç¤ºï¼šæ•°å€¼æ˜æ˜¾å¼‚å¸¸ï¼Œè¯·å°½å¿«è”ç³»åŒ»ç”Ÿæˆ–å°±åŒ»ï¼Œç‰¹åˆ«æ˜¯ä¼´æœ‰èƒ¸ç—›ã€æ°”çŸ­ã€å¤´æ™•ç­‰ç—‡çŠ¶æ—¶ã€‚';
                alertBox.innerHTML = `<span class="bp-hr-alert-icon">ğŸš¨</span> ${issues.join('ã€')}<br>${advice}`;
            }

            return { issues, level };
        }

        // ==================== è¯„ä¼°è¡€å‹å¿ƒç‡çŠ¶æ€ï¼ˆç”¨äºè®°å½•ä¿å­˜ï¼‰ ====================
        function assessVitalSigns(bpSys, bpDia, heartRate) {
            if (!bpSys && !bpDia && !heartRate) return null;

            let issues = [];
            let level = 'normal';

            if (bpSys) {
                if (bpSys < 90 || bpSys > 140) {
                    if (bpSys < 90 || bpSys > 180) level = 'danger';
                    else if (level !== 'danger') level = 'warning';
                }
            }

            if (bpDia) {
                if (bpDia < 60 || bpDia > 90) {
                    if (bpDia < 60 || bpDia > 110) level = 'danger';
                    else if (level !== 'danger') level = 'warning';
                }
            }

            if (heartRate) {
                if (heartRate < 60 || heartRate > 100) {
                    if (heartRate < 50 || heartRate > 120) level = 'danger';
                    else if (level !== 'danger') level = 'warning';
                }
            }

            return level;
        }

        // ==================== ä¿å­˜ä»Šå¤©çš„è®°å½• ====================
        function saveTodayRecord() {
            const settings = getSettings();
            if (!settings.surgeryDate) {
                showToast('è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­å¡«å†™æ‰‹æœ¯æ—¥æœŸ');
                return;
            }

            const phaseInfo = calculatePhase(settings.surgeryDate);
            const today = new Date().toISOString().split('T')[0];

            // æ”¶é›†æ•°æ®
            const smoked = todayData.smoke;
            const drank = todayData.drink;
            const medsTaken = todayData.meds;

            if (smoked === undefined || drank === undefined || medsTaken === undefined) {
                showToast('è¯·å®Œæˆæˆ’çƒŸã€æˆ’é…’å’Œåƒè¯çš„æ‰“å¡');
                return;
            }

            const exerciseMinutes = parseInt(document.getElementById('exercise-minutes').value) || 0;
            const bpSys = parseInt(document.getElementById('bp-sys').value) || null;
            const bpDia = parseInt(document.getElementById('bp-dia').value) || null;
            const heartRate = parseInt(document.getElementById('heart-rate').value) || null;

            const symptoms = [];
            document.querySelectorAll('input[name="symptom"]:checked').forEach(cb => {
                symptoms.push(cb.value);
            });

            const note = document.getElementById('note').value.trim();

            const exerciseTarget = settings.exerciseMode === 'custom' ?
                (settings.customExerciseTarget || phaseInfo.target) : phaseInfo.target;

            // è¯„ä¼°è¡€å‹å¿ƒç‡çŠ¶æ€
            const vitalSignsLevel = assessVitalSigns(bpSys, bpDia, heartRate);

            const record = {
                date: today,
                phase: phaseInfo.phase,
                smoked,
                drank,
                medsTaken,
                exerciseMinutes,
                exerciseTarget,
                bpSys,
                bpDia,
                heartRate,
                vitalSignsLevel, // ä¿å­˜è¡€å‹å¿ƒç‡è¯„ä¼°çŠ¶æ€
                symptoms,
                note
            };

            // ä¿å­˜è®°å½•
            const records = getRecords();
            const existingIndex = records.findIndex(r => r.date === today);

            if (existingIndex >= 0) {
                records[existingIndex] = record;
            } else {
                records.push(record);
            }

            saveRecords(records);

            // æ˜¾ç¤ºé¼“åŠ±è¯æˆ–è­¦å‘Š
            const encouragements = [
                'å¤ªæ£’äº†ï¼ä»Šå¤©åˆå®Œæˆäº†ä¸€å¤©çš„ç›®æ ‡ï¼',
                'åšæŒå°±æ˜¯èƒœåˆ©ï¼çˆ¸çˆ¸åŠ æ²¹ï¼',
                'æ¯ä¸€å¤©çš„åŠªåŠ›éƒ½åœ¨è®©å¿ƒè„æ›´å¼ºå£®ï¼',
                'è®°å½•å·²ä¿å­˜ï¼ç»§ç»­ä¿æŒå¥½ä¹ æƒ¯ï¼',
                'åšå¾—å¥½ï¼å¥åº·çš„ç”Ÿæ´»æ–¹å¼æ­£åœ¨å…»æˆï¼'
            ];

            let message = encouragements[Math.floor(Math.random() * encouragements.length)];

            // ä¼˜å…ˆçº§ï¼šå¸çƒŸ/å–é…’ > è¡€å‹å¿ƒç‡å±é™© > ç—‡çŠ¶è­¦å‘Š > è¡€å‹å¿ƒç‡è­¦å‘Š > æ­£å¸¸é¼“åŠ±
            if (smoked && drank) {
                message = 'ğŸš¨ğŸš¨ğŸš¨ è­¦å‘Šï¼å¸çƒŸ+é¥®é…’ä¼šå¯¼è‡´å¿ƒæ¢—å¤å‘é£é™©æ€¥å‰§å¢åŠ ï¼Œä¸¥é‡å±åŠç”Ÿå‘½ï¼è¯·ç«‹å³åœæ­¢ï¼';
            } else if (smoked) {
                message = 'ğŸš¨ ä¸¥é‡è­¦å‘Šï¼å¿ƒæ¢—æœ¯åå¸çƒŸä¼šä½¿å†æ¬¡å¿ƒæ¢—é£é™©å¢åŠ 2-3å€ï¼Œéšæ—¶å¯èƒ½çŒæ­»ï¼è¯·ç«‹å³æˆ’çƒŸï¼';
            } else if (drank) {
                message = 'ğŸš¨ ä¸¥é‡è­¦å‘Šï¼å¿ƒæ¢—æœ¯åé¥®é…’ä¼šå¢åŠ çŒæ­»é£é™©ï¼Œå¹¶å¯èƒ½ä¸å¿ƒè„è¯ç‰©äº§ç”Ÿå±é™©ååº”ï¼è¯·ç«‹å³æˆ’é…’ï¼';
            } else if (vitalSignsLevel === 'danger') {
                message = 'ğŸš¨ è®°å½•å·²ä¿å­˜ã€‚è¡€å‹/å¿ƒç‡æ•°å€¼æ˜æ˜¾å¼‚å¸¸ï¼Œè¯·å°½å¿«è”ç³»åŒ»ç”Ÿæˆ–å°±åŒ»ï¼';
            } else if (symptoms.includes('èƒ¸ç—›') || symptoms.includes('æ°”çŸ­')) {
                message = 'âš ï¸ è®°å½•å·²ä¿å­˜ã€‚å‡ºç°èƒ¸ç—›/æ°”çŸ­ç­‰ç—‡çŠ¶ï¼Œè¯·å°½å¿«å°±åŒ»ï¼';
            } else if (vitalSignsLevel === 'warning') {
                message = 'âš ï¸ è®°å½•å·²ä¿å­˜ã€‚è¡€å‹/å¿ƒç‡ç•¥æœ‰å¼‚å¸¸ï¼Œè¯·ç»§ç»­è§‚å¯Ÿï¼Œå¦‚æŒç»­å¼‚å¸¸è¯·å’¨è¯¢åŒ»ç”Ÿã€‚';
            }

            showToast(message);
            loadTodayPage();
        }

        // ==================== åŠ è½½è®°å½•é¡µé¢ ====================
        function loadRecordsPage() {
            const records = getRecords();

            if (records.length === 0) {
                document.getElementById('records-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>è¿˜æ²¡æœ‰è®°å½•</div>
                    </div>
                `;
                document.getElementById('stat-smoke-current').textContent = '0';
                document.getElementById('stat-smoke-max').textContent = '0';
                document.getElementById('stat-drink-current').textContent = '0';
                document.getElementById('stat-drink-max').textContent = '0';
                document.getElementById('stat-avg-exercise').textContent = '0';
                return;
            }

            // ç»Ÿè®¡æ•°æ®
            const smokeStreak = calculateStreak(records, 'smoked');
            const drinkStreak = calculateStreak(records, 'drank');

            document.getElementById('stat-smoke-current').textContent = smokeStreak.current;
            document.getElementById('stat-smoke-max').textContent = smokeStreak.max;
            document.getElementById('stat-drink-current').textContent = drinkStreak.current;
            document.getElementById('stat-drink-max').textContent = drinkStreak.max;

            // è®¡ç®—7å¤©å¹³å‡è¿åŠ¨
            const sortedRecords = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
            const last7Records = sortedRecords.slice(0, 7);
            const avgExercise = last7Records.length > 0 ?
                Math.round(last7Records.reduce((sum, r) => sum + (r.exerciseMinutes || 0), 0) / last7Records.length) : 0;
            document.getElementById('stat-avg-exercise').textContent = avgExercise;

            // è®¡ç®—å¸çƒŸå–é…’æ¬¡æ•°
            const totalSmoked = records.filter(r => r.smoked === true).length;
            const totalDrank = records.filter(r => r.drank === true).length;
            const last30DaysSmoked = records.filter(r => {
                const recordDate = new Date(r.date);
                const today = new Date();
                const daysDiff = Math.floor((today - recordDate) / (1000 * 60 * 60 * 24));
                return daysDiff <= 30 && r.smoked === true;
            }).length;
            const last30DaysDrank = records.filter(r => {
                const recordDate = new Date(r.date);
                const today = new Date();
                const daysDiff = Math.floor((today - recordDate) / (1000 * 60 * 60 * 24));
                return daysDiff <= 30 && r.drank === true;
            }).length;

            // æ˜¾ç¤º/éšè—å±é™©è¡Œä¸ºç»Ÿè®¡å¡ç‰‡
            if (totalSmoked > 0 || totalDrank > 0) {
                document.getElementById('risky-behavior-stats').style.display = 'block';
                document.getElementById('stat-smoke-total').textContent = totalSmoked;
                document.getElementById('stat-drink-total').textContent = totalDrank;
                document.getElementById('stat-smoke-recent').textContent = last30DaysSmoked > 0 ? `ï¼ˆæœ€è¿‘30å¤©: ${last30DaysSmoked}æ¬¡ï¼‰` : '';
                document.getElementById('stat-drink-recent').textContent = last30DaysDrank > 0 ? `ï¼ˆæœ€è¿‘30å¤©: ${last30DaysDrank}æ¬¡ï¼‰` : '';
            } else {
                document.getElementById('risky-behavior-stats').style.display = 'none';
            }

            // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
            const listHtml = sortedRecords.map((record, index) => {
                const phaseNames = {
                    'protection': 'ä¿æŠ¤æœŸ',
                    'recovery': 'æ¢å¤æœŸ',
                    'strengthening': 'å¼ºå¿ƒæœŸ',
                    'maintenance': 'ç»´æŠ¤æœŸ'
                };

                // ç¡®å®šè¡€å‹å¿ƒç‡æ ‡ç­¾çš„æ ·å¼
                let bpHrTagClass = 'tag-info';
                let bpHrIcon = '';
                if (record.vitalSignsLevel === 'danger') {
                    bpHrTagClass = 'tag-danger';
                    bpHrIcon = 'ğŸš¨';
                } else if (record.vitalSignsLevel === 'warning') {
                    bpHrTagClass = 'tag-warning';
                    bpHrIcon = 'âš ï¸';
                }

                return `
                    <div class="record-item" onclick="toggleRecordDetail(${index})">
                        <div class="record-date">${record.date} Â· ${phaseNames[record.phase] || record.phase}</div>
                        <div class="record-summary">
                            <span class="record-tag ${!record.smoked ? 'tag-success' : 'tag-error'}">
                                æˆ’çƒŸ: ${!record.smoked ? 'âœ…' : 'âŒ'}
                            </span>
                            <span class="record-tag ${!record.drank ? 'tag-success' : 'tag-error'}">
                                æˆ’é…’: ${!record.drank ? 'âœ…' : 'âŒ'}
                            </span>
                            <span class="record-tag ${record.medsTaken ? 'tag-success' : 'tag-error'}">
                                åƒè¯: ${record.medsTaken ? 'âœ…' : 'âŒ'}
                            </span>
                            <span class="record-tag tag-info">
                                è¿åŠ¨: ${record.exerciseMinutes || 0}åˆ†é’Ÿ
                            </span>
                            ${record.bpSys ? `<span class="record-tag ${bpHrTagClass}">${bpHrIcon} ${record.bpSys}/${record.bpDia} (HR ${record.heartRate || '--'})</span>` : ''}
                        </div>
                        <div class="record-detail" id="detail-${index}">
                            ${record.exerciseTarget ? `<div class="record-detail-item">è¿åŠ¨ç›®æ ‡: ${record.exerciseTarget}åˆ†é’Ÿ ${record.exerciseMinutes >= record.exerciseTarget ? 'âœ…è¾¾æ ‡' : ''}</div>` : ''}
                            ${record.bpSys || record.bpDia || record.heartRate ? `<div class="record-detail-item">è¡€å‹å¿ƒç‡: ${record.bpSys || '--'}/${record.bpDia || '--'} mmHg, å¿ƒç‡: ${record.heartRate || '--'} æ¬¡/åˆ†</div>` : ''}
                            ${record.symptoms && record.symptoms.length > 0 ? `<div class="record-detail-item">ç—‡çŠ¶: ${record.symptoms.join('ã€')}</div>` : ''}
                            ${record.note ? `<div class="record-detail-item">å¤‡æ³¨: ${record.note}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('records-list').innerHTML = listHtml;
        }

        // ==================== åˆ‡æ¢è®°å½•è¯¦æƒ… ====================
        function toggleRecordDetail(index) {
            const detail = document.getElementById(`detail-${index}`);
            detail.classList.toggle('show');
        }

        // ==================== åŠ è½½è®¾ç½®é¡µé¢ ====================
        function loadSettingsPage() {
            const settings = getSettings();
            document.getElementById('surgery-date').value = settings.surgeryDate || '';

            selectOption('exercise-mode', settings.exerciseMode || 'auto');

            if (settings.exerciseMode === 'custom') {
                document.getElementById('custom-exercise-input').style.display = 'block';
                document.getElementById('custom-exercise-target').value = settings.customExerciseTarget || '';
            } else {
                document.getElementById('custom-exercise-input').style.display = 'none';
            }
        }

        // ==================== ä¿å­˜è®¾ç½® ====================
        function saveSettings() {
            const surgeryDate = document.getElementById('surgery-date').value;

            if (!surgeryDate) {
                showToast('è¯·å¡«å†™æ‰‹æœ¯æ—¥æœŸ');
                return;
            }

            const settings = {
                surgeryDate,
                exerciseMode: todayData['exercise-mode'] || 'auto',
                customExerciseTarget: parseInt(document.getElementById('custom-exercise-target').value) || null
            };

            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            showToast('è®¾ç½®å·²ä¿å­˜');
            loadTodayPage();
        }

        // ==================== å¯¼å‡ºæ•°æ® ====================
        function exportData() {
            const records = getRecords();
            const settings = getSettings();

            const data = {
                settings,
                records,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `å¿ƒè„åº·å¤è®°å½•_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showToast('æ•°æ®å·²å¯¼å‡º');
        }

        // ==================== æ¸…ç©ºæ‰€æœ‰è®°å½• ====================
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem(STORAGE_KEYS.RECORDS);
                showToast('æ‰€æœ‰è®°å½•å·²æ¸…ç©º');
                loadRecordsPage();
                loadTodayPage();
            }
        }

        // ==================== LocalStorage æ“ä½œ ====================
        function getRecords() {
            const data = localStorage.getItem(STORAGE_KEYS.RECORDS);
            return data ? JSON.parse(data) : [];
        }

        function saveRecords(records) {
            localStorage.setItem(STORAGE_KEYS.RECORDS, JSON.stringify(records));
        }

        function getSettings() {
            const data = localStorage.getItem(STORAGE_KEYS.SETTINGS);
            return data ? JSON.parse(data) : {};
        }

        // ==================== æ˜¾ç¤ºæç¤º ====================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // ==================== æ£€æŸ¥ç®¡ç† ====================

        // è·å–æ£€æŸ¥è®°å½•
        function getCheckups() {
            const data = localStorage.getItem(STORAGE_KEYS.CHECKUPS);
            return data ? JSON.parse(data) : null;
        }

        // ä¿å­˜æ£€æŸ¥è®°å½•
        function saveCheckups(checkups) {
            localStorage.setItem(STORAGE_KEYS.CHECKUPS, JSON.stringify(checkups));
        }

        // åˆå§‹åŒ–æ£€æŸ¥è®¡åˆ’ï¼ˆæ ¹æ®æ‰‹æœ¯æ—¥æœŸï¼‰
        function initializeCheckups(surgeryDate) {
            const surgery = new Date(surgeryDate);

            // è®¡ç®—å„ä¸ªæ£€æŸ¥çš„æ¨èæ—¥æœŸ
            const firstLipidStart = new Date(surgery);
            firstLipidStart.setDate(firstLipidStart.getDate() + 28); // 4å‘¨

            const firstLipidEnd = new Date(surgery);
            firstLipidEnd.setDate(firstLipidEnd.getDate() + 56); // 8å‘¨

            const echoStart = new Date(surgery);
            echoStart.setDate(echoStart.getDate() + 42); // 6å‘¨

            const echoEnd = new Date(surgery);
            echoEnd.setDate(echoEnd.getDate() + 84); // 12å‘¨

            const secondLipidDate = new Date(surgery);
            secondLipidDate.setDate(secondLipidDate.getDate() + 90); // 3ä¸ªæœˆ

            const annualCheckDate = new Date(surgery);
            annualCheckDate.setDate(annualCheckDate.getDate() + 365); // 12ä¸ªæœˆ

            return {
                firstLipid: {
                    name: 'è¡€è„‚æ£€æŸ¥ï¼ˆç¬¬ä¸€æ¬¡ï¼‰',
                    dueStart: firstLipidStart.toISOString().split('T')[0],
                    dueEnd: firstLipidEnd.toISOString().split('T')[0],
                    done: false,
                    LDL: null,
                    completedDate: null
                },
                echoECG: {
                    name: 'å¿ƒç”µå›¾ + å¿ƒè„å½©è¶…',
                    dueStart: echoStart.toISOString().split('T')[0],
                    dueEnd: echoEnd.toISOString().split('T')[0],
                    done: false,
                    EF: null,
                    completedDate: null
                },
                secondLipid: {
                    name: 'è¡€è„‚æ£€æŸ¥ï¼ˆç¬¬äºŒæ¬¡ï¼‰',
                    dueDate: secondLipidDate.toISOString().split('T')[0],
                    done: false,
                    LDL: null,
                    completedDate: null
                },
                annualCheck: {
                    name: 'å¹´åº¦ç»¼åˆå¤æŸ¥',
                    dueDate: annualCheckDate.toISOString().split('T')[0],
                    done: false,
                    LDL: null,
                    EF: null,
                    completedDate: null
                }
            };
        }

        // è·å–ä¸‹ä¸€ä¸ªå¾…å®Œæˆçš„æ£€æŸ¥
        function getNextCheckup(checkups) {
            if (!checkups) return null;

            const today = new Date().toISOString().split('T')[0];
            const checkupList = [
                { id: 'firstLipid', ...checkups.firstLipid },
                { id: 'echoECG', ...checkups.echoECG },
                { id: 'secondLipid', ...checkups.secondLipid },
                { id: 'annualCheck', ...checkups.annualCheck }
            ];

            for (const checkup of checkupList) {
                if (!checkup.done) {
                    const dueDate = checkup.dueDate || checkup.dueStart;
                    return { id: checkup.id, ...checkup, dueDateDisplay: dueDate };
                }
            }

            return null;
        }

        // è®¡ç®—è·ç¦»æ£€æŸ¥çš„å‰©ä½™å¤©æ•°
        function getDaysUntilCheckup(dueDate) {
            const today = new Date();
            const due = new Date(dueDate);
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // åˆ¤æ–­LDLæ˜¯å¦è¾¾æ ‡
        function assessLDL(ldl) {
            if (ldl === null || ldl === undefined) return null;
            if (ldl < 1.4) return 'good';
            if (ldl < 1.8) return 'warning';
            return 'danger';
        }

        // åˆ¤æ–­EFæ˜¯å¦è¾¾æ ‡
        function assessEF(ef) {
            if (ef === null || ef === undefined) return null;
            if (ef >= 50) return 'good';
            if (ef >= 40) return 'warning';
            return 'danger';
        }

        // åŠ è½½æ£€æŸ¥é¡µé¢
        function loadCheckupsPage() {
            const settings = getSettings();
            if (!settings.surgeryDate) {
                document.getElementById('checkup-list').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div>è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­å¡«å†™æ‰‹æœ¯æ—¥æœŸ</div></div>';
                return;
            }

            let checkups = getCheckups();
            if (!checkups) {
                // é¦–æ¬¡åˆå§‹åŒ–æ£€æŸ¥è®¡åˆ’
                checkups = initializeCheckups(settings.surgeryDate);
                saveCheckups(checkups);
            }

            // æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ£€æŸ¥
            const nextCheckup = getNextCheckup(checkups);
            if (nextCheckup) {
                const daysUntil = getDaysUntilCheckup(nextCheckup.dueDateDisplay);
                const dueText = daysUntil > 0 ? `è¿˜æœ‰ ${daysUntil} å¤©` : daysUntil === 0 ? 'ä»Šå¤©' : `å·²é€¾æœŸ ${Math.abs(daysUntil)} å¤©`;
                document.getElementById('next-checkup-info').innerHTML = `<strong>${nextCheckup.name}</strong><br>${dueText}ï¼ˆ${nextCheckup.dueDateDisplay}ï¼‰`;
                document.getElementById('next-checkup-card').style.display = 'block';
            } else {
                document.getElementById('next-checkup-card').style.display = 'none';
            }

            // æ¸²æŸ“æ£€æŸ¥åˆ—è¡¨
            renderCheckupList(checkups);
        }

        // æ¸²æŸ“æ£€æŸ¥åˆ—è¡¨
        function renderCheckupList(checkups) {
            const today = new Date().toISOString().split('T')[0];
            const checkupList = [
                { id: 'firstLipid', ...checkups.firstLipid, timeRange: `${checkups.firstLipid.dueStart} è‡³ ${checkups.firstLipid.dueEnd}`, hasLDL: true },
                { id: 'echoECG', ...checkups.echoECG, timeRange: `${checkups.echoECG.dueStart} è‡³ ${checkups.echoECG.dueEnd}`, hasEF: true },
                { id: 'secondLipid', ...checkups.secondLipid, timeRange: checkups.secondLipid.dueDate, hasLDL: true },
                { id: 'annualCheck', ...checkups.annualCheck, timeRange: checkups.annualCheck.dueDate, hasLDL: true, hasEF: true }
            ];

            const html = checkupList.map(checkup => {
                const dueDate = checkup.dueDate || checkup.dueStart;
                const daysUntil = getDaysUntilCheckup(dueDate);

                let statusClass = 'pending';
                let statusText = 'å¾…å®Œæˆ';
                let itemClass = 'checkup-item';

                if (checkup.done) {
                    statusClass = 'done';
                    statusText = 'å·²å®Œæˆ';
                    itemClass += ' done';
                } else if (daysUntil < 0) {
                    statusClass = 'overdue';
                    statusText = `å·²é€¾æœŸ ${Math.abs(daysUntil)} å¤©`;
                    itemClass += ' overdue';
                } else if (daysUntil <= 7) {
                    itemClass += ' upcoming';
                    statusText = `è¿˜æœ‰ ${daysUntil} å¤©`;
                }

                let resultHtml = '';
                if (checkup.done) {
                    if (checkup.hasLDL && checkup.LDL !== null) {
                        const ldlStatus = assessLDL(checkup.LDL);
                        resultHtml += `<div class="checkup-result ${ldlStatus}">`;
                        if (ldlStatus === 'good') {
                            resultHtml += `âœ… LDL: ${checkup.LDL} mmol/Lï¼ˆè¾¾æ ‡ï¼‰`;
                        } else if (ldlStatus === 'warning') {
                            resultHtml += `âš ï¸ LDL: ${checkup.LDL} mmol/Lï¼ˆåé«˜ï¼Œéœ€è¦æ§åˆ¶ï¼‰`;
                        } else {
                            resultHtml += `ğŸš¨ LDL: ${checkup.LDL} mmol/Lï¼ˆä¸¥é‡è¶…æ ‡ï¼Œè¯·ç«‹å³å°±åŒ»è°ƒæ•´ç”¨è¯ï¼‰`;
                        }
                        resultHtml += `</div>`;
                    }
                    if (checkup.hasEF && checkup.EF !== null) {
                        const efStatus = assessEF(checkup.EF);
                        resultHtml += `<div class="checkup-result ${efStatus}">`;
                        if (efStatus === 'good') {
                            resultHtml += `âœ… EF: ${checkup.EF}%ï¼ˆæ­£å¸¸ï¼‰`;
                        } else if (efStatus === 'warning') {
                            resultHtml += `âš ï¸ EF: ${checkup.EF}%ï¼ˆåä½ï¼Œéœ€è¦æ³¨æ„ï¼‰`;
                        } else {
                            resultHtml += `ğŸš¨ EF: ${checkup.EF}%ï¼ˆä¸¥é‡åä½ï¼Œé«˜é£é™©ï¼Œéœ€ä¸¥æ ¼ç®¡ç†ï¼‰`;
                        }
                        resultHtml += `</div>`;
                    }
                }

                let inputHtml = '';
                if (!checkup.done) {
                    inputHtml = '<div class="checkup-input-group">';
                    if (checkup.hasLDL) {
                        inputHtml += `<input type="number" id="${checkup.id}-ldl" placeholder="LDL (mmol/L)" step="0.1" min="0">`;
                    }
                    if (checkup.hasEF) {
                        inputHtml += `<input type="number" id="${checkup.id}-ef" placeholder="EF (%)" step="1" min="0" max="100">`;
                    }
                    inputHtml += `<button onclick="markCheckupDone('${checkup.id}')">å®Œæˆ</button>`;
                    inputHtml += '</div>';
                } else {
                    // å·²å®Œæˆçš„æ£€æŸ¥æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®
                    inputHtml = '<div class="checkup-input-group">';
                    inputHtml += `<button onclick="clearCheckupData('${checkup.id}')" style="background: #ff4d4f; border-color: #ff4d4f;">æ¸…é™¤æ•°æ®</button>`;
                    inputHtml += '</div>';
                }

                return `
                    <div class="${itemClass}">
                        <div class="checkup-header">
                            <div class="checkup-title">${checkup.name}</div>
                            <div class="checkup-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="checkup-info">
                            æ¨èæ—¶é—´ï¼š${checkup.timeRange}
                            ${checkup.done && checkup.completedDate ? `<br>å®Œæˆæ—¥æœŸï¼š${checkup.completedDate}` : ''}
                        </div>
                        ${inputHtml}
                        ${resultHtml}
                    </div>
                `;
            }).join('');

            document.getElementById('checkup-list').innerHTML = html;
        }

        // æ ‡è®°æ£€æŸ¥å®Œæˆ
        function markCheckupDone(checkupId) {
            const checkups = getCheckups();
            const checkup = checkups[checkupId];

            // è¯»å–è¾“å…¥å€¼
            const ldlInput = document.getElementById(`${checkupId}-ldl`);
            const efInput = document.getElementById(`${checkupId}-ef`);

            if (ldlInput) {
                const ldlValue = parseFloat(ldlInput.value);
                if (!ldlValue || ldlValue <= 0) {
                    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ LDL å€¼');
                    return;
                }
                checkup.LDL = ldlValue;
            }

            if (efInput) {
                const efValue = parseFloat(efInput.value);
                if (!efValue || efValue <= 0) {
                    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ EF å€¼');
                    return;
                }
                checkup.EF = efValue;
            }

            checkup.done = true;
            checkup.completedDate = new Date().toISOString().split('T')[0];

            saveCheckups(checkups);
            showToast('æ£€æŸ¥è®°å½•å·²ä¿å­˜');
            loadCheckupsPage();
        }

        // æ¸…é™¤æ£€æŸ¥æ•°æ®
        function clearCheckupData(checkupId) {
            // ç¡®è®¤æç¤º
            if (!confirm('ç¡®å®šè¦æ¸…é™¤è¿™ä¸ªæ£€æŸ¥çš„æ•°æ®å—ï¼Ÿæ¸…é™¤åå¯ä»¥é‡æ–°è¾“å…¥ã€‚')) {
                return;
            }

            const checkups = getCheckups();
            const checkup = checkups[checkupId];

            // é‡ç½®æ£€æŸ¥æ•°æ®
            checkup.done = false;
            checkup.LDL = null;
            checkup.EF = null;
            checkup.completedDate = null;

            saveCheckups(checkups);
            showToast('æ£€æŸ¥æ•°æ®å·²æ¸…é™¤');
            loadCheckupsPage();

            // å¦‚æœåœ¨ä»Šæ—¥é¡µé¢ï¼Œä¹Ÿæ›´æ–°ä»Šæ—¥é¡µé¢ï¼ˆä»¥ä¾¿é‡æ–°è®¡ç®—å¼ºåŒ–æ¨¡å¼ï¼‰
            if (document.getElementById('page-today').classList.contains('active')) {
                loadTodayPage();
            }
        }

        // åœ¨ä»Šå¤©é¡µé¢æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ£€æŸ¥
        function showNextCheckupInToday() {
            const settings = getSettings();
            if (!settings.surgeryDate) return;

            let checkups = getCheckups();
            if (!checkups) {
                checkups = initializeCheckups(settings.surgeryDate);
                saveCheckups(checkups);
            }

            const nextCheckup = getNextCheckup(checkups);
            if (nextCheckup) {
                const daysUntil = getDaysUntilCheckup(nextCheckup.dueDateDisplay);
                const dueText = daysUntil > 0 ? `è¿˜æœ‰ ${daysUntil} å¤©` : daysUntil === 0 ? 'ä»Šå¤©ï¼' : `å·²é€¾æœŸ ${Math.abs(daysUntil)} å¤©`;

                document.getElementById('next-checkup-today-content').innerHTML = `ğŸ©º <strong>ä¸‹ä¸€ä¸ªæ£€æŸ¥ï¼š</strong>${nextCheckup.name}ï¼ˆ${dueText}ï¼‰`;
                document.getElementById('next-checkup-today').style.display = 'block';
            } else {
                document.getElementById('next-checkup-today').style.display = 'none';
            }
        }

        // ==================== æ˜¾ç¤º/éšè—é£é™©è­¦å‘Š ====================
        function updateRiskWarning(task, didRiskyBehavior) {
            const warningId = task === 'smoke' ? 'smoke-risk-warning' : 'drink-risk-warning';
            const statsId = task === 'smoke' ? 'smoke-stats' : 'drink-stats';
            const warningElement = document.getElementById(warningId);
            const statsElement = document.getElementById(statsId);

            if (didRiskyBehavior) {
                // æ˜¾ç¤ºè­¦å‘Š
                warningElement.classList.add('show');

                // ç»Ÿè®¡å†å²è®°å½•
                const records = getRecords();
                const settings = getSettings();

                if (settings.surgeryDate) {
                    const totalCount = records.filter(r => r[task + 'd'] === true).length;
                    const last30Days = records.filter(r => {
                        const recordDate = new Date(r.date);
                        const today = new Date();
                        const daysDiff = Math.floor((today - recordDate) / (1000 * 60 * 60 * 24));
                        return daysDiff <= 30 && r[task + 'd'] === true;
                    }).length;

                    const behaviorName = task === 'smoke' ? 'å¸çƒŸ' : 'é¥®é…’';

                    if (totalCount > 0 || last30Days > 0) {
                        statsElement.innerHTML = `âš ï¸ æ‚¨åœ¨æœ¯åå·²ç»${behaviorName} <strong>${totalCount}</strong> æ¬¡${last30Days > 0 ? `ï¼ˆæœ€è¿‘30å¤©: <strong>${last30Days}</strong> æ¬¡ï¼‰` : ''}ã€‚<br>æ¯æ¬¡${behaviorName}éƒ½åœ¨å¢åŠ ç”Ÿå‘½å±é™©ï¼è¯·ç«‹å³åœæ­¢ï¼`;
                    } else {
                        statsElement.innerHTML = `âš ï¸ è¿™æ˜¯æ‚¨æœ¯åç¬¬ä¸€æ¬¡è®°å½•${behaviorName}ï¼Œè¯·ç«‹å³åœæ­¢ï¼Œä¸è¦è®©å®ƒæˆä¸ºä¹ æƒ¯ï¼`;
                    }
                }
            } else {
                // éšè—è­¦å‘Š
                warningElement.classList.remove('show');
            }
        }

        // ==================== ä»»åŠ¡é€‰é¡¹ç‚¹å‡»äº‹ä»¶ ====================
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('task-option')) {
                const task = e.target.dataset.task;
                const value = e.target.dataset.value;

                // æ¸…é™¤åŒç»„å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll(`[data-task="${task}"]`).forEach(opt => {
                    opt.classList.remove('selected-yes', 'selected-no');
                });

                // è®¾ç½®å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                if (task === 'smoke' || task === 'drink') {
                    e.target.classList.add(value === 'false' ? 'selected-yes' : 'selected-no');
                    todayData[task] = value === 'true';

                    // æ˜¾ç¤º/éšè—é£é™©è­¦å‘Š
                    updateRiskWarning(task, value === 'true');
                } else if (task === 'meds') {
                    e.target.classList.add(value === 'true' ? 'selected-yes' : 'selected-no');
                    todayData[task] = value === 'true';
                } else if (task === 'exercise-mode') {
                    e.target.classList.add('selected-yes');
                    todayData[task] = value;

                    if (value === 'custom') {
                        document.getElementById('custom-exercise-input').style.display = 'block';
                    } else {
                        document.getElementById('custom-exercise-input').style.display = 'none';
                    }
                }
            }
        });

        // ==================== é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– ====================
        window.addEventListener('load', async function() {
            // å…ˆåŠ è½½é…ç½®æ•°æ®
            await loadConfigData();

            // ç„¶ååŠ è½½é¡µé¢
            loadTodayPage();
        });
    </script>
</body>
</html>
